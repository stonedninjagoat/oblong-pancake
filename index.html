<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MIDI Tempo Extractor & CSV Export</title>
<script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 600px;
    margin: auto;
  }
  #tempoList {
    margin-top: 20px;
  }
  button {
    margin-top: 15px;
  }
  pre {
    background: #f4f4f4;
    padding: 10px;
    overflow-x: auto;
  }
</style>
</head>
<body>

<h2>MIDI Tempo Extractor & CSV Export</h2>

<input type="file" id="midiFile" accept=".mid,.midi" />
<div id="tempoList"></div>

<button id="exportCsvBtn" disabled>Export Tempo Data as CSV</button>

<script>
  const midiFileInput = document.getElementById('midiFile');
  const tempoListDiv = document.getElementById('tempoList');
  const exportCsvBtn = document.getElementById('exportCsvBtn');
  
  let currentTempos = []; // store tempos for export

  midiFileInput.addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    const arrayBuffer = await file.arrayBuffer();
    const midi = new Midi(arrayBuffer);
    
    // Extract tempos from midi.header.tempos
    // Each tempo has: ticks, bpm, time
    // If no tempos, default BPM = 120
    let tempos = midi.header.tempos;
    if (tempos.length === 0) {
      tempos = [{ ticks: 0, bpm: 120, time: 0 }];
    }
    
    currentTempos = tempos; // Save for CSV export
    
    // Display tempos nicely
    let html = `<h3>Tempos found in file "${file.name}"</h3>`;
    html += '<table border="1" cellpadding="5" cellspacing="0">';
    html += '<tr><th>Index</th><th>Tick Position</th><th>Time (seconds)</th><th>BPM</th></tr>';
    tempos.forEach((tempo, i) => {
      html += `<tr>
        <td>${i + 1}</td>
        <td>${tempo.ticks}</td>
        <td>${tempo.time.toFixed(3)}</td>
        <td>${tempo.bpm.toFixed(2)}</td>
      </tr>`;
    });
    html += '</table>';
    
    tempoListDiv.innerHTML = html;
    exportCsvBtn.disabled = false;
  });

  exportCsvBtn.addEventListener('click', () => {
    if (!currentTempos.length) return;

    // Create CSV string
    let csv = 'Index,Tick Position,Time (seconds),BPM\n';
    currentTempos.forEach((tempo, i) => {
      csv += `${i + 1},${tempo.ticks},${tempo.time.toFixed(3)},${tempo.bpm.toFixed(2)}\n`;
    });

    // Trigger CSV download
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'midi_tempos.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
</script>

</body>
</html>
