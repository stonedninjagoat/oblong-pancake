<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MIDI File Validator</title>
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input { margin-bottom: 20px; }
    .success { color: green; white-space: pre-wrap; }
    .error { color: red; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>MIDI File Validator</h1>
  <input type="file" id="midiInput" multiple accept=".mid,.midi">
  <div id="results"></div>

  <script>
    document.getElementById("midiInput").addEventListener("change", async (event) => {
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      for (const file of event.target.files) {
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const midi = new Midi(e.target.result);
            const fileName = file.name;
            const originalTrackCount = midi.tracks.length;
            let messages = [];

            // Merge tracks if more than 1
            if (originalTrackCount > 1) {
              const mergedTrack = midi.tracks.reduce((merged, current) => {
                merged.notes.push(...current.notes);
                return merged;
              }, new Midi().addTrack());
              midi.tracks = [mergedTrack];
              messages.push("merge success");
            }

            // Check for percussion (channel 9 = percussion)
            const isPercussive = midi.tracks[0].notes.some(note => note.channel === 9);
            if (isPercussive) {
              messages.unshift(`${fileName}: percussive`);
            }

            // Get BPM
            let bpm = 120;
            let bpmSource = "default (120)";
            const tempos = midi.header.tempos;
            if (tempos.length === 1) {
              bpm = tempos[0].bpm;
              bpmSource = bpm.toFixed(2);
            } else if (tempos.length > 1) {
              bpm = tempos[0].bpm;
              bpmSource = `multiple detected, using first (${bpm.toFixed(2)})`;
            }

            // Time signatures
            const timeSignatures = midi.header.timeSignatures.map(sig =>
              `${sig.time} = ${sig.numerator}/${sig.denominator}`
            ).join(", ") || "none";

            // Note data: [midi#, duration]
            const noteList = midi.tracks[0].notes.map(n =>
              `[${n.midi}, ${n.duration.toFixed(3)}]`
            ).join(", ");

            // Compose output
            const baseInfo =
              `BPM: ${bpmSource}\n` +
              `Tracks: ${originalTrackCount} â†’ ${midi.tracks.length}\n` +
              `Time Signatures: ${timeSignatures}\n` +
              `Notes: ${noteList}`;

            const resultMsg = isPercussive
              ? `<div class="error"><strong>${fileName}</strong>: ${messages.join(", ")}\n${baseInfo}</div>`
              : `<div class="success"><strong>${fileName}</strong>: upload success\n${messages.join(", ")}\n${baseInfo}</div>`;

            resultsDiv.innerHTML += resultMsg;
          } catch (err) {
            resultsDiv.innerHTML += `<div class="error"><strong>${file.name}</strong>: failed to read MIDI file (${err.message})</div>`;
          }
        };
        reader.readAsArrayBuffer(file);
      }
    });
  </script>
</body>
</html>
