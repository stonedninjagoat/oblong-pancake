<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MIDI Validator</title>
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .success { color: green; }
    .error { color: red; }
    pre { background: #f0f0f0; padding: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>Upload MIDI Files</h2>
  <input type="file" id="fileInput" multiple accept=".mid,.midi">
  <ul id="resultList"></ul>

  <script>
    const fileInput = document.getElementById("fileInput");
    const resultList = document.getElementById("resultList");

    fileInput.addEventListener("change", async (event) => {
      resultList.innerHTML = "";
      const files = event.target.files;

      for (const file of files) {
        const li = document.createElement("li");
        const pre = document.createElement("pre");
        const errors = [];
        let bpmDisplay = "unknown";
        let timeSignaturesDisplay = "none";

        try {
          const arrayBuffer = await file.arrayBuffer();
          const midi = new Midi(arrayBuffer);

          const trackCount = midi.tracks.length;
          if (trackCount !== 1) {
            errors.push(`contains ${trackCount < 1 ? 'less' : 'more'} than 1 track`);
          }

          const hasPercussion = midi.tracks.some(track =>
            track.notes.some(note => note.channel === 9)
          );
          if (hasPercussion) {
            errors.push("percussive");
          }

          const tempos = midi.header.tempos;
          if (tempos.length !== 1) {
            errors.push(`contains ${tempos.length < 1 ? 'less' : 'more'} than 1 BPM`);
          } else {
            bpmDisplay = tempos[0].bpm.toFixed(2);
          }

          if (midi.header.timeSignatures.length > 0) {
            timeSignaturesDisplay = midi.header.timeSignatures.map(ts => `${ts.timeSignature[0]}/${ts.timeSignature[1]}`).join(", ");
          }

          const extraInfo = `Tracks: ${trackCount}\nBPM: ${bpmDisplay}\nTime Signature(s): ${timeSignaturesDisplay}`;

          li.className = errors.length ? "error" : "success";
          li.innerHTML = `<strong>${file.name}:</strong> ${errors.length ? errors.join(', ') : 'upload success'}<br><pre>${extraInfo}</pre>`;

        } catch (err) {
          li.textContent = `${file.name}: error reading MIDI`;
          li.className = "error";
        }

        resultList.appendChild(li);
      }
    });
  </script>
</body>
</html>
