<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MIDI File Validator</title>
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input { margin-bottom: 20px; }
    .success { color: green; }
    .error { color: red; }
    pre { background: #f0f0f0; padding: 10px; }
  </style>
</head>
<body>
  <h1>MIDI File Validator</h1>
  <input type="file" id="midiInput" multiple accept=".mid,.midi">
  <div id="results"></div>

  <script>
    document.getElementById("midiInput").addEventListener("change", async (event) => {
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      for (const file of event.target.files) {
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const midi = new Midi(e.target.result);
            const originalTrackCount = midi.tracks.length;

            // Merge tracks if there's more than one
            if (originalTrackCount > 1) {
              const mergedTrack = midi.tracks.reduce((merged, current) => {
                merged.notes.push(...current.notes);
                return merged;
              }, new Midi().addTrack());
              midi.tracks = [mergedTrack];
            }

            // Check for percussive content (channel 9 = percussion)
            const isPercussive = midi.tracks[0].notes.some(note => note.channel === 9);

            // BPM check
            let bpm = 120;
            let bpmSource = "default (120)";
            const tempos = midi.header.tempos;
            if (tempos.length === 1) {
              bpm = tempos[0].bpm;
              bpmSource = bpm.toFixed(2);
            } else if (tempos.length > 1) {
              // Keep first tempo for simplicity
              bpm = tempos[0].bpm;
              bpmSource = `multiple detected, using first (${bpm.toFixed(2)})`;
            }

            const messages = [];
            const fileName = file.name;

            if (isPercussive) {
              messages.push(`${fileName}: percussive`);
            }

            const resultMsg = messages.length > 0
              ? `<div class="error"><strong>${fileName}</strong>: ${messages.join(", ")}<br>BPM: ${bpmSource}<br>Tracks: ${originalTrackCount} → merged to 1</div>`
              : `<div class="success"><strong>${fileName}</strong>: upload success<br>BPM: ${bpmSource}<br>Tracks: ${originalTrackCount} → merged to 1</div>`;

            resultsDiv.innerHTML += resultMsg;
          } catch (err) {
            resultsDiv.innerHTML += `<div class="error"><strong>${file.name}</strong>: failed to read MIDI file (${err.message})</div>`;
          }
        };
        reader.readAsArrayBuffer(file);
      }
    });
  </script>
</body>
</html>
