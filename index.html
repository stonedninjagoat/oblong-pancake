<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MIDI Info Extractor</title>
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #output { margin-top: 20px; white-space: pre-wrap; }
  </style>
</head>
<body>

  <h1>MIDI to CSV Tool</h1>
  <p>Ensure MIDI files have only one track and do not contain percussion.</p>

  <input type="file" id="midiInput" accept=".mid,.midi" multiple />
  <button onclick="processFiles()">Process MIDI Files</button>

  <div id="output"></div>

  <script>
    // import necessary

    function processFiles() {
      const files = document.getElementById('midiInput').files;
      for (const file of files) {
        const reader = new FileReader();
        reader.onload = async (e) => {
          const midiData = new Uint8Array(e.target.result);
          const midi = new Midi(midiData);
          const filename = file.name.replace(/\.[^/.]+$/, "");
          const cleanedMidi = uploadCheck(midi, filename);

          function uploadCheck(midi, filename) {
  const numTracks = midi.tracks.length;
  console.log(`${filename}: contains ${numTracks} track(s)`);

  if (numTracks === 0) {
    throw new Error(`${filename}: contains no tracks.`);
  }

  if (numTracks === 1) {
    return midi; // Already acceptable
  }

  // Merge all tracks into a single one
  const mergedTrack = midi.tracks[0].notes.slice(); // clone of first track notes
  for (let i = 1; i < midi.tracks.length; i++) {
    mergedTrack.push(...midi.tracks[i].notes);
  }

  // Sort all notes by their start time to preserve musical order
  mergedTrack.sort((a, b) => a.time - b.time);

  // Create new Midi object with single merged track
  const newMidi = new Midi();
  const track = newMidi.addTrack();

  for (const note of mergedTrack) {
    track.addNote({
      midi: note.midi,
      time: note.time,
      duration: note.duration,
      velocity: note.velocity
    });
  }

  console.log(`${filename}: merged ${numTracks} tracks into one.`);
  return newMidi;
}

          // getTempos {
          //   // if more than 1 tempo, apply the tempo covering the most measures.
          //   // store tempo to variable “FILENAME_tempo”
          //   // if no tempo, default to 120.
          // }

          // getNoteDurations {
          //   // store duration of each note to FILENAME_NoteDurations = []
          // }

          // convertNoteDurations {
          //   // standardize each duration to ¼, ½, dotted, triplet, etc
          //   // group simultaneous notes: ex [1, 2, [3, 4, 5], 6]
          // }

          // getMIDInumber {
          //   // store MIDI number of each note to FILENAME_MIDInumbers = []
          // }

          // convertMIDInumber {
          //   // convert MIDI numbers to Jianpu scale + octave
          //   // FILENAME_convertedMIDInumbers = [[num, oct], [], …]
          // }

          // getTimeSigs {
          //   // store time signature of each measure to FILENAME_timeSigs = []
          // }

          // organizeMeasures {
          //   // group note durations into measures by time signature
          //   // FILENAME_groupedData = []
          // }

          // for every imported MIDI file {
          //   getTempos()
          //   getNoteDurations()
          //   convertNoteDurations()
          //   getMIDInumber()
          //   convertMIDInumber()
          //   getTimeSigs()
          //   organizeMeasures()
          // }

          // return CSV with:
          // {
          //   FILENAME_tempo
          //   FILENAME_convertedMIDInumbers = []
          //   FILENAME_groupedData = []
          // }

          // display CSV output
          // document.getElementById('output').textContent += filename + '.csv content here\n';
        };
        reader.readAsArrayBuffer(file);
      }
    }
  </script>
</body>
</html>
