<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MIDI Validator</title>
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .success { color: green; }
    .error { color: red; }
    pre { background: #f0f0f0; padding: 10px; white-space: pre-wrap; }
    a.download { display: block; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Upload MIDI Files</h2>
  <input type="file" id="fileInput" multiple accept=".mid,.midi">
  <ul id="resultList"></ul>

  <script>
    const fileInput = document.getElementById("fileInput");
    const resultList = document.getElementById("resultList");

    function getNoteLengthLabel(note, ppq) {
      const ticks = note.durationTicks;
      const quarterTicks = ppq;
      const baseDur = ticks / quarterTicks;
      const labels = {
        4: 'whole',
        2: 'half',
        1: 'quarter',
        0.5: 'eighth',
        0.25: 'sixteenth',
        0.125: 'thirty-second',
        0.0625: 'sixty-fourth'
      };
      for (let dur in labels) {
        if (Math.abs(baseDur - dur) < 0.01) return `1/${1/dur} (${labels[dur]} note)`;
      }
      return `${baseDur.toFixed(4)} (custom)`;
    }

    function midiToJianpu(midiNote, key = "C") {
      const scale = [0, 2, 4, 5, 7, 9, 11];
      const base = 60; // Middle C
      const rel = (midiNote - base + 120) % 12;
      const octave = Math.floor((midiNote - base) / 12) + 4;
      const degree = scale.indexOf(rel);
      return degree >= 0 ? [degree + 1, octave] : ["x", octave];
    }

    function downloadCSV(filename, rows) {
      const csvContent = rows.map(e => e.map(v => `"${v}"`).join(",")).join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", filename);
      link.className = "download";
      link.textContent = `Download CSV for ${filename}`;
      return link;
    }

    fileInput.addEventListener("change", async (event) => {
      resultList.innerHTML = "";
      const files = event.target.files;

      for (const file of files) {
        const li = document.createElement("li");
        const pre = document.createElement("pre");
        const errors = [];
        let bpmDisplay = "unknown";
        let dataOutput = {};

        try {
          const arrayBuffer = await file.arrayBuffer();
          const midi = new Midi(arrayBuffer);

          if (midi.tracks.length !== 1) {
            errors.push(`contains ${midi.tracks.length < 1 ? 'less' : 'more'} than 1 track`);
          }

          const hasPercussion = midi.tracks.some(track =>
            track.notes.some(note => note.channel === 9)
          );
          if (hasPercussion) {
            errors.push("percussive");
          }

          const tempos = midi.header.tempos;
          let bpm = 120;
          if (tempos.length === 0) {
            bpmDisplay = "120 (default)";
          } else if (tempos.length === 1) {
            bpm = tempos[0].bpm;
            bpmDisplay = bpm.toFixed(2);
          } else {
            errors.push("contains more than 1 BPM");
            bpmDisplay = tempos.map(t => t.bpm.toFixed(2)).join(", ");
          }

          if (errors.length === 0) {
            const track = midi.tracks[0];
            const notes = track.notes;
            const note_pitches = [];
            const note_values = [];
            const note_number = [];
            const ppq = midi.header.ppq;
            const csvRows = [["Pitch (MIDI)", "Duration", "Jianpu Degree", "Jianpu Octave"]];

            for (let note of notes) {
              note_pitches.push(note.midi);
              let label = getNoteLengthLabel(note, ppq);
              note_values.push(label);
              let jianpu = midiToJianpu(note.midi);
              note_number.push(jianpu);
              csvRows.push([note.midi, label, jianpu[0], jianpu[1]]);
            }

            const time_signatures = midi.header.timeSignatures.map(ts => `${ts.timeSignature[0]}/${ts.timeSignature[1]}`);

            dataOutput = {
              tempo: `BPM = ${bpm}`,
              time_signatures,
              note_pitches,
              note_values,
              note_number
            };

            pre.textContent = JSON.stringify(dataOutput, null, 2);
            li.appendChild(pre);
            li.appendChild(downloadCSV(file.name.replace(/\.[^/.]+$/, "") + ".csv", csvRows));
          }

          li.className = errors.length > 0 ? "error" : "success";
          li.insertAdjacentText("afterbegin", `${file.name}: ${errors.length > 0 ? errors.join(', ') : 'upload success'} [BPM: ${bpmDisplay}]\n`);

        } catch (err) {
          li.textContent = `${file.name}: error reading MIDI`;
          li.className = "error";
        }

        resultList.appendChild(li);
      }
    });
  </script>
</body>
</html>
