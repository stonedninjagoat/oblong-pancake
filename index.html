<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MIDI File Validator</title>
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input { margin-bottom: 20px; }
    .success { color: green; }
    .error { color: red; }
    pre { background: #f0f0f0; padding: 10px; }
  </style>
</head>
<body>
  <h1>MIDI File Validator</h1>
  <input type="file" id="midiInput" multiple accept=".mid,.midi">
  <div id="results"></div>

  <script>
    document.getElementById("midiInput").addEventListener("change", async (event) => {
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      for (const file of event.target.files) {
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const midi = new Midi(e.target.result);
            const trackCount = midi.tracks.length;
            const tempos = midi.header.tempos;
            const bpmList = tempos.map(t => t.bpm);
            const uniqueBPMs = [...new Set(bpmList.map(bpm => bpm.toFixed(2)))];

            // Check if any percussive channels (channel 9 = percussion)
            const isPercussive = midi.tracks.some(track =>
              track.notes.some(note => note.channel === 9)
            );

            const fileName = file.name;
            let messages = [];

            if (trackCount !== 1) {
              messages.push(`${fileName}: contains ${trackCount < 1 ? "less" : "more"} than 1 track`);
            }

            if (isPercussive) {
              messages.push(`${fileName}: percussive`);
            }

            if (uniqueBPMs.length !== 1) {
              messages.push(`${fileName}: contains ${uniqueBPMs.length < 1 ? "no" : "more"} than 1 BPM`);
            }

            const resultMsg = messages.length > 0
              ? `<div class="error"><strong>${fileName}</strong>: ${messages.join(", ")}<br>BPMs: ${uniqueBPMs.join(", ") || "none"}<br>Tracks: ${trackCount}</div>`
              : `<div class="success"><strong>${fileName}</strong>: upload success<br>BPM: ${uniqueBPMs[0]}<br>Tracks: ${trackCount}</div>`;

            resultsDiv.innerHTML += resultMsg;
          } catch (err) {
            resultsDiv.innerHTML += `<div class="error"><strong>${file.name}</strong>: failed to read MIDI file (${err.message})</div>`;
          }
        };
        reader.readAsArrayBuffer(file);
      }
    });
  </script>
</body>
</html>
