<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MIDI Combiner Tool</title>
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { margin: 10px 0; }
  </style>
</head>
<body>
  <h2>MIDI Combiner Tool</h2>
  <input type="file" id="midiFiles" multiple accept=".mid,.midi">
  <br>
  <button onclick="processMIDIs()">Process and Export Combined MIDI</button>
  <p id="status"></p>

  <script>
    function transposeToCMajor(track) {
      // Naively assumes the track is in a major key. Detects root and shifts to C.
      const notes = track.notes;
      if (notes.length === 0) return;

      // Get the most common note pitch class
      const pitchClasses = new Array(12).fill(0);
      notes.forEach(n => pitchClasses[n.midi % 12]++);
      const mostCommon = pitchClasses.indexOf(Math.max(...pitchClasses));

      const shift = (0 - mostCommon + 12) % 12; // shift root to C (0)
      notes.forEach(n => n.midi += shift);
    }

    async function processMIDIs() {
      const files = document.getElementById("midiFiles").files;
      if (files.length === 0) {
        document.getElementById("status").innerText = "Please upload MIDI files.";
        return;
      }

      const midiList = [];
      const bpms = [];

      // Load and analyze all MIDI files
      for (const file of files) {
        const arrayBuffer = await file.arrayBuffer();
        const midi = new Midi(arrayBuffer);
        if (midi.header.tempos.length > 0) {
          midi.header.tempos.forEach(t => bpms.push(t.bpm));
        } else {
          bpms.push(120); // default if missing
        }

        // Transpose all tracks in the MIDI to C major
        midi.tracks.forEach(track => transposeToCMajor(track));
        midiList.push(midi);
      }

      // Calculate average BPM
      const avgBPM = bpms.reduce((a, b) => a + b, 0) / bpms.length;

      // Create new MIDI file and set tempo
      const combinedMidi = new Midi();
      combinedMidi.header.setTempo(avgBPM);

      let currentTime = 0;

      for (const midi of midiList) {
        for (const track of midi.tracks) {
          const newTrack = combinedMidi.addTrack();

          for (const note of track.notes) {
            newTrack.addNote({
              midi: note.midi,
              time: note.time + currentTime,
              duration: note.duration,
              velocity: note.velocity
            });
          }

          for (const cc of track.controlChanges) {
            Object.values(cc).forEach(event => {
              newTrack.addCC({
                number: event.number,
                value: event.value,
                time: event.time + currentTime
              });
            });
          }
        }

        // Update current time to append next MIDI after this one
        const midiDuration = midi.duration;
        currentTime += midiDuration;
      }

      // Export the combined MIDI
      const bytes = combinedMidi.toArray();
      const blob = new Blob([bytes], { type: 'audio/midi' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "combined_standardized.mid";
      a.click();

      document.getElementById("status").innerText = "Exported combined MIDI!";
    }
  </script>
</body>
</html>
