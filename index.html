<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MIDI Validator</title>
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>
<body>
  <h2>Upload MIDI Files</h2>
  <input type="file" id="fileInput" multiple accept=".mid,.midi">
  <ul id="resultList"></ul>

  <script>
    const fileInput = document.getElementById("fileInput");
    const resultList = document.getElementById("resultList");

    fileInput.addEventListener("change", async (event) => {
      resultList.innerHTML = "";
      const files = event.target.files;

      for (const file of files) {
        const li = document.createElement("li");
        const errors = [];
        let bpmDisplay = "unknown";

        try {
          const arrayBuffer = await file.arrayBuffer();
          const midi = new Midi(arrayBuffer);

          // === Track Count Check ===
          if (midi.tracks.length !== 1) {
            errors.push(`contains ${midi.tracks.length < 1 ? 'less' : 'more'} than 1 track`);
          }

          // === Percussion Check ===
          const hasPercussion = midi.tracks.some(track =>
            track.notes.some(note => note.channel === 9)
          );
          if (hasPercussion) {
            errors.push("percussive");
          }

          // === BPM Check ===
          const tempos = midi.header.tempos;
          if (tempos.length === 0) {
            bpmDisplay = "120 (default)";
          } else if (tempos.length === 1) {
            bpmDisplay = tempos[0].bpm.toFixed(2);
          } else {
            errors.push("contains more than 1 BPM");
            bpmDisplay = tempos.map(t => t.bpm.toFixed(2)).join(", ");
          }

          // === Display Result ===
          if (errors.length > 0) {
            li.textContent = `${file.name}: ${errors.join(', ')} [BPM: ${bpmDisplay}]`;
            li.className = "error";
          } else {
            li.textContent = `${file.name}: upload success [BPM: ${bpmDisplay}]`;
            li.className = "success";
          }

        } catch (err) {
          li.textContent = `${file.name}: error reading MIDI`;
          li.className = "error";
        }

        resultList.appendChild(li);
      }
    });
  </script>
</body>
</html>
