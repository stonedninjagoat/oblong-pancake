<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MIDI Info Extractor</title>
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input { margin-bottom: 20px; }
    pre { background: #f0f0f0; padding: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>MIDI File Analyzer</h1>
  <input type="file" id="midiFile" accept=".mid" />
  <pre id="output">Upload a MIDI file to see its data...</pre>

  <script>
    const noteToJianpu = (note, key = 0) => {
      const scale = [0, 2, 4, 5, 7, 9, 11]; // C major scale
      const degree = scale.indexOf((note - key + 12) % 12) + 1;
      const octave = Math.floor(note / 12) - 1;
      return [degree, octave];
    };

    const getDurationLabel = (ticks, ppq, timeSig) => {
      const beatTicks = ppq;
      const quarterNote = 1 / timeSig[1];
      const base = ticks / beatTicks;

      if (base === 0.25) return '1/4';
      if (base === 0.5) return '1/2';
      if (base === 0.125) return '1/8';
      if (base === 0.375) return 'dotted 1/4';
      if (base === 1 / 3) return 'triplet 1/4';
      return base.toFixed(3);
    };

    document.getElementById('midiFile').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const arrayBuffer = await file.arrayBuffer();
      const midi = new Midi(arrayBuffer);

      const track = midi.tracks.find(t => t.notes.length > 0);
      if (!track) return document.getElementById('output').textContent = "No note data.";

      const ppq = midi.header.ppq;
      const bpm = midi.header.tempos[0]?.bpm || 120;
      const timeSignatures = midi.header.timeSignatures.map(sig => `${sig.timeSignature[0]}/${sig.timeSignature[1]}`);
      const noteEvents = track.notes.map(n => ({
        pitch: n.midi,
        time: n.time,
        durationTicks: n.ticks,
        duration: n.duration,
        label: getDurationLabel(n.ticks, ppq, [4, 4])
      }));

      const note_pitches = [];
      const note_values = [];
      const jianpu = [];

      for (let n of noteEvents) {
        note_pitches.push(n.pitch);
        note_values.push(n.label);
        jianpu.push(noteToJianpu(n.pitch));
      }

      // Grouped notes by time
      const grouped_notes = [];
      let currentTime = 0;
      let buffer = [];

      for (let i = 0; i < noteEvents.length; i++) {
        const curr = noteEvents[i];
        const next = noteEvents[i + 1];

        buffer.push([[...noteToJianpu(curr.pitch)], curr.label]);

        if (!next || next.time > curr.time + 0.01) {
          grouped_notes.push(buffer);
          buffer = [];
        }
      }

      const output = {
        tempo: `BPM = ${bpm}`,
        time_signatures: timeSignatures,
        note_pitches: note_pitches,
        note_values: note_values,
        note_number: jianpu,
        grouped_notes: grouped_notes
      };

      document.getElementById('output').textContent = JSON.stringify(output, null, 2);
    });
  </script>
</body>
</html>
