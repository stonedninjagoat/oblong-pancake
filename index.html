<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MIDI Analyzer</title>
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    pre { background: #f0f0f0; padding: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>MIDI File Analyzer</h2>
  <input type="file" id="fileInput" accept=".mid" />
  <pre id="output">Upload a MIDI file to begin...</pre>

  <script>
    function toFraction(duration, ppq) {
      const quarterTicks = ppq;
      const value = duration / quarterTicks;

      if (Math.abs(value - 1) < 0.01) return "1/4";
      if (Math.abs(value - 0.5) < 0.01) return "1/8";
      if (Math.abs(value - 0.25) < 0.01) return "1/16";
      if (Math.abs(value - 2) < 0.01) return "1/2";
      if (Math.abs(value - 4) < 0.01) return "1";
      if (Math.abs(value - 1.5) < 0.01) return "dotted 1/4";
      if (Math.abs(value - 0.333) < 0.01) return "triplet 1/4";
      return value.toFixed(3);
    }

    function toJianpu(midiNote, keyRoot = 0) {
      const scale = [0, 2, 4, 5, 7, 9, 11];
      const pc = (midiNote - keyRoot + 12) % 12;
      const degree = scale.indexOf(pc) + 1 || "x"; // x = chromatic or out of scale
      const octave = Math.floor(midiNote / 12) - 1;
      return [degree, octave];
    }

    function groupSimultaneous(notes, tolerance = 0.01) {
      const groups = [];
      let group = [notes[0]];

      for (let i = 1; i < notes.length; i++) {
        if (Math.abs(notes[i].time - notes[i - 1].time) < tolerance) {
          group.push(notes[i]);
        } else {
          groups.push(group);
          group = [notes[i]];
        }
      }
      if (group.length) groups.push(group);
      return groups;
    }

    document.getElementById("fileInput").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      const arrayBuffer = await file.arrayBuffer();
      const midi = new Midi(arrayBuffer);

      const output = {};

      // Tempo
      const tempoEvent = midi.header.tempos[0];
      output.tempo = `BPM = ${tempoEvent ? tempoEvent.bpm.toFixed(2) : "120 (default)"}`;

      // Time Signatures
      output.time_signatures = midi.header.timeSignatures.map(t => `${t.timeSignature[0]}/${t.timeSignature[1]}`);

      // Track (first non-empty)
      const track = midi.tracks.find(t => t.notes.length > 0);
      if (!track) {
        document.getElementById("output").textContent = "No valid notes found in file.";
        return;
      }

      const ppq = midi.header.ppq;
      const notes = track.notes;

      const grouped = groupSimultaneous(notes);

      const note_pitches = [];
      const note_values = [];
      const note_number = [];
      const grouped_notes = [];

      grouped.forEach(group => {
        const pitches = group.map(n => n.midi).sort((a, b) => a - b);
        const durations = group.map(n => toFraction(n.ticks, ppq));
        const jianpu = group.map(n => [toJianpu(n.midi)[0], toFraction(n.ticks, ppq)]);
        note_pitches.push(pitches.length > 1 ? pitches : pitches[0]);
        note_values.push(durations.length > 1 ? durations : durations[0]);
        note_number.push(group.map(n => toJianpu(n.midi)));
        grouped_notes.push(jianpu);
      });

      output.note_pitches = note_pitches;
      output.note_values = note_values;
      output.note_number = note_number;
      output.grouped_notes = grouped_notes;

      document.getElementById("output").textContent = JSON.stringify(output, null, 2);
    });
  </script>
</body>
</html>
